"use strict";var app=angular.module("app",["ngRoute","ngTouch","ctrl","services","filters"]);app.config(["$routeProvider","$httpProvider","$locationProvider",function(e,t){var o=ctx+"html/v3/";e.when("/login",{templateUrl:o+"comm/detail.html",controller:o+"goodsDetailCtrl"}).when("/home",{templateUrl:o+"seller/home.html",controller:"homeCtrl",title:"周边看看"}).when("/seller/:id",{templateUrl:o+"seller/seller.html",controller:"sellerCtrl",title:"店铺首页"}).when("/seller",{templateUrl:o+"seller/seller.html",controller:"sellerCtrl",title:"店铺首页"}).when("/active",{templateUrl:o+"actives/index.html",controller:"sellerCtrl",title:"活动页"}).when("/goods/activelist",{templateUrl:o+"actives/activelist.html",controller:"goodsCatCtrl",title:"活动列表页"}).when("/seller/:id/scope",{templateUrl:o+"seller/scope.html",controller:"scopeCtrl",title:"配送范围"}).when("/seller/detail/:id",{templateUrl:o+"seller/detail.html",controller:"sellerDetailCtrl",title:"店铺详情"}).when("/goods/cat",{templateUrl:o+"goods/category.html",controller:"goodsCatCtrl",title:"商品分类"}).when("/goods/cat/:id/search",{templateUrl:o+"goods/search.html",controller:"searchCtrl",title:"商品搜索"}).when("/goods/detail",{templateUrl:o+"goods/detail.html",controller:"goodsDetailCtrl as dCtrl",title:"商品详情"}).when("/cart",{templateUrl:o+"orders/cart.html",controller:"cartCtrl",auth:!0,title:"购物车"}).when("/order/list",{templateUrl:o+"orders/order.html",controller:"orderCtrl",auth:!0,title:"订单列表"}).when("/order/detail/:oid",{templateUrl:o+"orders/detail.html",controller:"orderDetailCtrl",auth:!0,title:"订单详情"}).when("/my",{templateUrl:o+"my/mycenter.html",controller:"myCtrl",auth:!0,title:"个人中心"}).when("/address/edit/:id",{templateUrl:o+"address/address.edit.html",controller:"addressEditCtrl",auth:!0,title:"地址编辑"}).when("/address/list/:type",{templateUrl:o+"address/address.list.html",controller:"addressListCtrl",auth:!0,title:"地址列表"}).when("/my/coupon",{templateUrl:o+"my/coupons.html",controller:"myCouponCtrl",auth:!0,title:"个人中心"}).when("/my/collections",{templateUrl:o+"my/collections.html",controller:"mycollectionCtrl",auth:!0,title:"收藏页"}).when("/my/feedback",{templateUrl:o+"my/feedback.html",controller:"myfeedbackCtrl",auth:!0,title:"反馈"}).when("/order/confirm/:sellerId",{templateUrl:o+"orders/corder.html",controller:"corderCtrl",auth:!0,title:"确认下单"}).when("/scan_pay/:sellerId",{templateUrl:o+"pay/pay.html",controller:"scanPayMentCtrl",title:"扫码支付"}).when("/scan_pay_success/:orderId",{templateUrl:o+"pay/paysuccess.html",controller:"scanPaySuccessCtrl",title:"支付成功"}).otherwise({redirectTo:"/home"}),t.interceptors.push("MsgInterceptor"),t.interceptors.push("TokenInterceptor")}]),app.run(["$rootScope","$location","$document","authService",function(e,t,o,n){e.$on("$routeChangeStart",function(t,o){void 0!=o.$$route&&o.$$route.auth&&!n.isLogin()&&(e.$broadcast("isLogin",!1),t.preventDefault())}),e.$on("$routeChangeSuccess",function(e,t){if(void 0!=t.$$route){var n=t.$$route.title;o[0].title=void 0==n?"花啦生活":n}})}]);var filters=angular.module("filters",[]);filters.filter("checkmark",function(){return function(e){return e?"✓":"✘"}}),filters.filter("tofixd",function(){return function(e){if(null!=e)return e.toFixed(1)}}),filters.filter("dateformat",function(){return function(e){if(null!=e){e=e.substring(0,19),e=e.replace(/-/g,"/");var t=new Date(e).getTime();return t}}});var ctrl=angular.module("ctrl",["ngCookies","services"]);ctrl.controller("baseCtrl",["$scope","authService","$templateRequest","$compile","$interval","$route","$cookies",function(e,t,o,n,r,s,c){e.imgUrl=imgUrl,e.dotscroll=!1;var i;e.sendClass="发送验证码",e.remove=function(t){e.code=e.phone=void 0,angular.element(document.getElementById(t)).remove()},e.login=function(){t.login(e.phone,e.code).success(function(t){t.success?(e.remove("loginForm"),e.isLogin=!0,s.reload()):alert(t.message)})},e.logout=function(e){t.logout().success(function(e){e.success})},e.sendCode=function(){angular.isDefined(i)||(e.second=60,e.sendClass="60s",t.sendCode(e.phone).success(function(t){console.log(t),t.success?i=r(function(t){e.sendClass=e.second--+"s",e.second<=0&&(e.sendClass="发送验证码",r.cancel(i),i=void 0)},1e3):(e.sendClass="发送验证码",e.errormessage=t.message)}))},e.$on("isLogin",function(t,r){o(ctx+"/html/v3/comm/login.tpl.html").then(function(t){angular.element(document.getElementById("ng-view")).append(n(t)(e))})})}]),ctrl.controller("cartCtrl",["$scope","$http","cartService","$location","userService",function(e,t,o,n,r){r.getDefAddress().success(function(t){e.address=t.body}),o.getListBySeller().success(function(t){e.cartList=t.body}),e.changeCart=function(t,n){t.goodNum<=0&&o.getListBySeller().success(function(t){e.cartList=t.body}),n.total=0,n.cartList.forEach(function(e){e.choose&&(n.total=n.total+e.goodNum*e.salePrice)})},e.chooseAll=function(e){o.choose(e.sellerId,!e.chooseAll).success(function(t){var o=0;t.success&&(e.chooseAll=t.body,e.cartList.forEach(function(e){e.choose=t.body,e.choose&&(o+=e.goodNum*e.salePrice)}),e.total=o)})},e.choose=function(e,t){o.choose(e.sellerId,!t.choose,t.skuId).success(function(o){if(o.success){var n=0;t.choose=o.body;var r=!0;e.cartList.forEach(function(e){e.choose||(r=!1),e.choose&&(n+=e.goodNum*e.salePrice)}),e.total=n,e.chooseAll=r}})},e.confirmOrder=function(e){n.path("/order/confirm/"+e)}}]),ctrl.controller("goodsCatCtrl",["$scope","$http","$location","$routeParams","cartService","$anchorScroll","$cookieStore","wxService",function(e,t,o,n,r,s,c,i){e.cartList=r.getList(),e.loadingdata=!1;var l=c.get("gps"),a=void 0==n.sellerId?l.sellerId:n.sellerId;t.get(ctx+"/v3/goods/"+a+"/cat").success(function(t){e.cates=t.body.cat,e.subcatename=e.cates[0].cname,e.supplier=t.body.supplier,e.subcates=e.cates[0].subCatList,e.active=e.cates[0].cid}),e.sellerId=a,e.sellerName=n.sellerName,e.address=l.address,e.init=function(t,o,n,r){e.myVar=!1,e.show=!1,e.show2=!1,e.type=r,e.finish=!1,void 0!=n&&(e.subCateName=n),e.page=t,void 0!=o&&(e.cid=o),e.goodsList=[],e.currentActiveGoods=[]},e.getGoodsList=function(){if(!e.finish){var o=ctx+"v3/goods/"+a+"/list",s={params:{page:e.page,size:27,cateId:e.cid,type:e.type,sort:e.sort,supplierId:e.supplierId}};e.cartList.then(function(c){t.get(o,s).success(function(t){t.body.length<s.params.size&&(e.finish=!0),0==t.body.length&&(e.loadingdata=!0),t.body.forEach(function(t){t.goodNum=r.getCart(c.body,n.sellerId,t.skuId),void 0!==t.actImgUrl?e.currentActiveGoods.push(t):e.goodsList.push(t)}),e.page++})})}},e.getGoods=function(){e.getGoodsList()},e.subCat=function(t){e.subcates=t.subCatList,e.active=t.cid,e.subcatename=t.cname},e.getCat=function(t,o,n){e.init(1,t,o,n),e.getGoodsList()},e.getSup=function(t){e.supplierId=t,e.init(1,e.cid,e.cname,e.type),e.getGoodsList()},e.getSort=function(t){e.sort=t,e.init(1,e.cid,e.cname,e.type),e.getGoodsList()},n.supplierId&&""!=n.supplierId?(e.getSup(n.supplierId),n.cname="全部分类"):e.getCat(n.cid,void 0==n.cname?"全部分类":n.cname,n.type),e.gotop=function(){s("top")},n.actImg&&""!=n.actImg&&(e.actImg=n.actImg);var d=o.protocol()+"://"+location.host+ctx+"goshopgoods/"+e.sellerId;i.menuShare(e.sellerName,d,o.protocol()+"://"+location.host+ctx+"assets/v3/images/huala-logo.jpg",e.sellerName+"店的商品列表")}]),ctrl.controller("searchCtrl",["$scope","$http","$routeParams","cartService","$cookieStore",function(e,t,o,n,r){var s=r.get("gps"),c=void 0==o.id?s.sellerId:o.id;e.sellerId=c,e.searchFocus=!0,e.cartList=n.getList(),e.init=function(t,o){e.page=t,e.finish=o},e.init(1),e.goodsList=[],e.searchItems=function(o){if(e.key=o,!e.finish){var r=ctx+"v3/goods/"+c+"/search",s={params:{key:o,page:e.page,size:27}};e.cartList.then(function(o){t.get(r,s).success(function(t){0==t.body.length&&(e.finish=!0),t.body.forEach(function(t){t.goodNum=n.getCart(o.body,c,t.skuId),e.goodsList.push(t)}),e.page++})})}},e.searchMyItems=function(t){e.init(1),e.goodsList=[],e.searchItems(t)},e.mykeyUp=function(t){var o=window.event?t.keyCode:t.which;""!==e.key&&13==o&&(e.init(1),e.goodsList=[],e.searchItems(e.key))}}]),ctrl.controller("goodsDetailCtrl",["$scope","$http","$location","$routeParams","$sce","$anchorScroll","wxService",function(e,t,o,n,r,s,c){var i=this;e.getGraphic=function(){e.GoodsDetail&&""!=e.GoodsDetail&&(i.explicitlyTrustedHtml=r.trustAsHtml(e.GoodsDetail),s("graphic-details"))};var l="";t.get(ctx+"/v3/goods/"+n.sellerId+"/"+n.goodsId).success(function(t){e.goods=t.body.goods,e.seller=t.body.seller,e.goods.goodsDetail&&""!=e.goods.goodsDetail?(e.GoodsDetail=e.goods.goodsDetail,e.showGoodsDetail=!0):(e.showGoodsDetail=!1,e.GoodsDetail=void 0),l=void 0!=e.goods.picUrl&&""!=e.goods.picUrl?imgUrl+e.goods.picUrl+"?s=220x220":o.protocol()+"://"+location.host+ctx+"assets/v3/images/huala-logo.jpg";var n=o.protocol()+"://"+location.host+ctx+"goshopgoodsdetail/"+e.seller.id+"/"+e.goods.id;c.menuShare(e.goods.title,n,l,e.seller.address+"　"+e.seller.name)}),t.get(ctx+"v3/iscollects/"+n.sellerId).success(function(t){e.show=t.success}),e.gotop=function(){s("top")}}]),ctrl.controller("corderCtrl",["$scope","$http","$routeParams","$compile","$location","orderService","userService",function(e,t,o,n,r,s,c){c.getDefAddress().success(function(t){e.address=t.body,s.getOrder(o.sellerId).success(function(t){e.order=t.body,e.redFn=function(o,n){void 0!=o&&o.sums<=t.body.goodAmount?(e.order.redId=o.id,e.order.redName=o.name,e.order.discountAmount=o.balance,n&&1==n?e.defaultshow=1:e.defaultshow=0):(e.order.redId=void 0,e.order.redName="不使用优惠券",e.order.discountAmount=0,e.defaultshow=0)},e.redFn(e.red,!1),void 0!=e.address&&(e.order.addressId=e.address.id),e.order.orderSendTime=e.order.bestTime;var n=t.body.orderGoods;e.ogoodslen=0;for(var c=0;c<n.length;c++)e.ogoodslen=e.ogoodslen+n[c].goodsNumber;e.shippingAmount=e.order.shippingAmount,e.cType=function(t){e.order.shippingType=t,0==t?e.order.shippingAmount=e.shippingAmount:e.order.shippingAmount=0},e.confirm_C=function(t){(void 0==e.order.orderGoods||e.order.orderGoods.length<=0)&&(alert("没有选择购物车，请选择购物车信息"),r.path("/cart")),s.confirm(o.sellerId,e.order).then(function(e){e.success?window.location.href=e.body:alert(e.message)})}})}),t.get(ctx+"v3/seller/detail/"+o.sellerId).success(function(t){e.seller=t.body}),e.showPops=function(t){e.order.sellerId=o.sellerId,angular.element(document.getElementById("ng-view")).append(n("<"+t+"></"+t+">")(e))}}]),ctrl.controller("homeCtrl",["$scope","$http","$cookieStore","$location","wxService",function(e,t,o,n,r){e.seller=[],e.page=0,e.exe=!1,e.loadingdata=!1,e.noMore=!1,e.getList=function(){var n=o.get("gps");if(n){if(e.exe||e.noMore)return;e.exe=!0,e.page=e.page+1;var r={params:{page:e.page,size:10,lat:n.lat,lng:n.lng,address:n.address}};t.get(ctx+"v3/seller/list",r).success(function(t){e.exe=!1,t.success&&(t.body.forEach(function(t,o){e.seller.push(t)}),void 0!=t.body&&t.body.length<10&&(e.noMore=!0),0==t.body.length&&(e.loadingdata=!0))})}};var s=n.protocol()+"://"+location.host+ctx;r.menuShare("周边看看",s,n.protocol()+"://"+location.host+ctx+"assets/v3/images/huala-logo.jpg","邀请你去周边看看")}]),ctrl.controller("sellerCtrl",["$scope","$http","$location","$compile","$routeParams","$cookieStore","wxService",function(e,t,o,n,r,s,c){e.getSeller=function(){var i=s.get("gps"),l=void 0==r.id?i.sellerId:r.id;t.get(ctx+"v3/seller",{params:{sellerId:l,lat:i.lat,lng:i.lng,address:i.address}}).success(function(r){r.body.actList&&r.body.actList.length>0&&(e.actList=r.body.actList),e.seller=r.body.seller,e.cat=r.body.cat,e.banners=r.body.banner,s.put("gps",r.body.gps),t.get(ctx+"v3/iscollects/"+e.seller.id).success(function(t){e.show=t.success}),angular.element(document.getElementById("ng-view")).append(n('<package-blank seller-id="seller.id" seller-name="seller.name"></package-blank>')(e));var i="";i=void 0!=e.seller.imgUrl&&""!=e.seller.imgUrl?imgUrl+e.seller.imgUrl+"?s=220x220":o.protocol()+"://"+location.host+ctx+"assets/v3/images/huala-logo.jpg";var l=o.protocol()+"://"+location.host+ctx+"goshop/"+e.seller.id;c.menuShare(e.seller.name,l,o.protocol()+"://"+location.host+ctx+"assets/v3/images/huala-logo.jpg",e.seller.address)})}}]),ctrl.controller("sellerDetailCtrl",["$scope","$http","$routeParams","$cookieStore",function(e,t,o,n){t.get(ctx+"v3/iscollects/"+o.id).success(function(t){e.show=t.success}),t.get(ctx+"v3/seller/detail/"+o.id).success(function(t){e.seller=t.body,e.lng=t.body.lng,e.lat=t.body.lat})}]),ctrl.controller("scopeCtrl",["$scope","$http","$routeParams","$cookieStore","$window",function(e,t,o,n,r){function s(){var e=document.createElement("script");e.type="text/javascript",e.src="http://api.map.baidu.com/api?v=2.0&ak=16005cc9538518f22a3b1c48fe36ea96&callback=init",document.body.appendChild(e)}r.init=function(){var e=(o.id,new BMap.Map("allmap")),t=new BMap.Point(o.lng,o.lat),r=new BMap.Point(o.lng,o.lat),s=new BMap.Icon(ctx+"assets/v3/images/localicon.png",new BMap.Size(45,45)),c=new BMap.Marker(r,{icon:s}),i=n.get("gps");if(void 0!=i){var l=new BMap.Point(i.lng,i.lat),a=new BMap.Icon(ctx+"assets/v3/images/locationDot.png",new BMap.Size(30,30)),d=new BMap.Marker(l,{icon:a});e.addOverlay(d)}c.addEventListener("click",function(){var o={width:100,height:10,title:data.body.aliasName,enableMessage:!1,message:""},n=new BMap.InfoWindow(data.body.address,o);e.openInfoWindow(n,t)});var u=new BMap.ScaleControl({anchor:BMAP_ANCHOR_TOP_LEFT});e.addControl(u);var m=new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_RIGHT,type:BMAP_NAVIGATION_CONTROL_SMALL});e.addControl(m),e.enableScrollWheelZoom(),e.centerAndZoom(t,15);var g=new BMap.Circle(t,2e3,{fillColor:"blue",fillOpacity:.3,strokeWeight:1,strokeOpacity:.3});e.addOverlay(c),e.addOverlay(g)},window.onload=s()}]),ctrl.controller("orderCtrl",["$scope","$http",function(e,t){e.getList=function(o){e.isHistory=o,t.get(ctx+"v3/order/list?isHistory="+o).success(function(t){e.orderList=t.body})},e.getList(!1)}]),ctrl.controller("orderDetailCtrl",["$scope","$http","$routeParams","$route",function(e,t,o,n){t.get(ctx+"v3/order/view/"+o.oid).success(function(t){e.orderDetail=t.body.order,e.orderDetail.seller=t.body.seller}),e.goPay=function(e){t.get(ctx+"pay/"+e,{params:{path:"v3"}}).success(function(e){e.success?window.location.href=e.body:alert(e.message)})},e.orderExec=function(o){t.get(ctx+"v3/order/orderStatus",{params:{orderId:e.orderDetail.id,orderStatus:o}}).success(function(e){e.success?n.reload():alert(e.message)})}}]),ctrl.controller("myCtrl",["$scope","$http","$location","$route","authService",function(e,t,o,n,r){e.logout=function(){r.logout().success(function(e){e.success&&o.path("/seller")})},t.get(ctx+"v3/center").success(function(t){e.user=t.body}),e.load=function(){window.location.href="http://mp.weixin.qq.com/s?__biz=MzAwNzYzNTYzOQ==&mid=504391207&idx=1&sn=713aba54307610d9c026a2273ebfbe5c#rd"},e.showfeedback=e.showfeedpop=!1,e.submittxt=function(){e.showfeedpop=!0;var t=angular.element(document.getElementById("content")).val();t.length<15?(e.invalid=!0,e.effective=!1):(e.invalid=!1,e.effective=!0)},e.submit=function(){angular.element(document.getElementById("content")).val();t.post(ctx+"v3/feedback").success(function(){n.reload()})}}]),ctrl.controller("myCouponCtrl",["$scope","userService",function(e,t){e.activeitem=!1,t.getcoupons().success(function(t){console.log(t.body),e.unused=[],e.used=[],void 0!=t.body&&t.body.forEach(function(t){"0"==t.isUse&&"0"==t.isInvalid?e.unused.push(t):e.used.push(t)})})}]),ctrl.controller("addressListCtrl",["$scope","$compile","$routeParams","$window","$cookieStore","userService",function(e,t,o,n,r,s){s.getAddressList().success(function(t){e.addressList=t.body}),e.routeparam=o.type,e.del=function(t){e.showdeletepop=!0,e.addressid=t},e.edit=function(e){window.location.href="#/address/edit/"+e},e.delok=function(e){s.address("del",e).success(function(e){e.success&&n.location.reload()})},e.add=function(t,o){e.addressId=t.id},e.change=function(e,t){t.stopPropagation&&t.stopPropagation(),"change"==o.type&&s.address("update",e.id,e).success(function(t){if(t.success){var o=r.get("gps");void 0==o&&(o={}),o.lng=e.lng,o.lat=e.lat,o.address=e.signBuilding,r.put("gps",o),sessionStorage.setItem("gps",JSON.stringify(o)),n.history.back()}})},e.getGps=function(){r.remove("gps"),n.history.back()}}]),ctrl.controller("addressEditCtrl",["$scope","$routeParams","$window","$compile","$cookieStore","userService",function(e,t,o,n,r,s){s.address("get",t.id).success(function(t){e.address=t.body}),e.submit=function(){var n="";n="-1"!=t.id?"update":"add",s.address(n,t.id,e.address).success(function(t){e.addressList=t.body,o.history.back()})},e.search=function(){angular.element(document.getElementById("ng-view")).append(n("<address-search address=address></address-search>")(e))}}]),ctrl.controller("mycollectionCtrl",["$scope","$window","userService",function(e,t,o){o.getcollects().success(function(t){e.clists=t.body}),e.collectid="0",e.showdeleteFn=function(t,o){o.forEach(function(o){o.id==t.id&&(e.collectid=t.id)})},e.cancelcollectFn=function(e){o.postcollect(e.id).success(function(e){t.location.reload()})}}]),ctrl.controller("scanPayMentCtrl",["$scope","$rootScope","$routeParams","userService","authService","$cookieStore","$route",function(e,t,o,n,r,s,c){function i(){var e=window.navigator.userAgent.toLowerCase();return"micromessenger"==e.match(/MicroMessenger/i)}var l=s.get("gps");void 0!=l?l.sellerId=o.sellerId:l={sellerId:o.sellerId},s.put("gps",l),e.isLogin=r.isLogin(),e.CanGotoPay=!1,e.showNumberBoarad=!0,n.scanPay(o.sellerId).success(function(t){e.seller=t.body.seller,e.card=t.body.card,e.content=t.body.content}),e.amount="",e.scanGoPay=function(t){var o=e.amount,r=e.payAmount,s=e.card,l=0,a=0;void 0!=s&&null!=s&&(l=s.actCartId,a=s.id);var d=!1;i()&&(d=!0),0!=o&&n.scanGoPay(t,r,o,l,a,d).success(function(e){e.success?d?n.goPay(e.body).success(function(e){e.success?window.location.href=e.body:alert(e.message)}):window.location.href=ctx+"ali_pay_req/"+e.body:(alert(e.message),"red_package_is_empty"==e.errorCode&&c.reload())})},e.showkeyBoard=function(){e.showNumberBoarad=!0,e.changeInput=!1},e.goLogin=function(){t.$broadcast("isLogin",!1),event.preventDefault()},e.getPayMoney=function(t){var o=100*e.amount;if(e.isLogin){var n=e.card;void 0!=n&&null!=n&&0==n.isUse&&o>=n.sums&&(o-n.balance>0?o-=n.balance:o=0)}o<0&&(o=0),e.payAmount=o.toFixed(2);var r=e.amount.length,s=e.amount.substring(0,1),c=e.amount.substring(r-1,r),i=e.amount.substring(r-2,r-1);1===r?"0"!==e.amount&&"."!==e.amount||(e.amount="0.00"):2===r?"."===s&&"0"===c?e.amount="0.00":"."===s&&"0"!==c?e.amount="0."+c+"0":"."!==s&&"."===c&&(e.amount+="00"):r>2&&("."===c&&"."!==i&&(e.amount+="00"),"."!==c&&"."===i&&(e.amount+="0")),e.showNumberBoarad=!1,e.amount.length>0?e.changeInput=!0:e.changeInput=!1}}]),ctrl.controller("scanPaySuccessCtrl",["$scope","$routeParams","userService",function(e,t,o){o.scanPaySuccess(t.orderId).success(function(t){e.order=t.body.order,e.sellerName=t.body.sellerName}),e.gotoPay=function(e){window.location.href=ctx+"v3/scan_code/"+e}}]);var services=angular.module("services",[]);services.factory("TokenInterceptor",["$q","$document","$location","$rootScope",function(e,t,o,n){return{request:function(e){return e.headers=e.headers||{},e},requestError:function(t){return e.reject(t)},response:function(t){return t||e.when(t)},responseError:function(t){return null!=t&&401===t.status&&n.$broadcast("isLogin","fasle"),e.reject(t)}}}]),services.factory("MsgInterceptor",["$q","$document","$location","$rootScope",function(e,t,o,n){return{request:function(e){return n.loading=!0,e},requestError:function(t){return n.loading=!1,e.reject(t)},response:function(t){return n.loading=!1,t||e.when(t)},responseError:function(t){return n.loading=!1,e.reject(t)}}}]),services.service("geoService",["$http","$q","$cookies",function(e,t,o){this.getGeo=function(o,n){var r=t.defer();return e.jsonp("//api.map.baidu.com/geocoder/v2/?ak=zHNmFc3z0ho52KdH0cH9mDF5LRiulbx6&callback=?&location="+n+","+o+"&output=json&pois=0&callback=JSON_CALLBACK").success(function(e){var t={lat:e.result.location.lat,lng:e.result.location.lng,address:e.result.sematic_description};r.resolve(t)}),r.promise}}]),services.service("wxService",[function(){this.menuShare=function(e,t,o,n){var r={title:e,link:t,imgUrl:o,desc:n,trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}};wx.config(wxconfig),wx.ready(function(){wx.onMenuShareTimeline(r),wx.onMenuShareAppMessage(r)})}}]),services.service("authService",["$http","$cookieStore",function(e,t){this.login=function(o,n){var r=t.get("gps");return e.post(ctx+"loginv",{phone:o,code:n,sellerId:void 0==r?void 0:r.sellerId})},this.logout=function(){return e.post(ctx+"logout")},this.sendCode=function(t){return e.post(ctx+"send?phone="+t,{phone:t})},this.isLogin=function(){var e=t.get("USERID");return void 0!=e}}]),services.service("cartService",["$http","$q","$rootScope",function(e,t,o){this.add=function(t,o){return e.post(ctx+"v3/cart/add",{sellerId:t,skuId:o})},this.reduce=function(t,o){return e.post(ctx+"v3/cart/reduce",{sellerId:t,skuId:o})},this.get=function(t,o){return e.get(ctx+"v3/cart/get",{sellerId:t,skuId:goodsSkuId})},this.getList=function(n){var r=t.defer();return e.get(ctx+"v3/cart/list",{sellerId:n}).success(function(e){void 0!=e.body&&e.body.length>0?o.$broadcast("cartIcon",!0):o.$broadcast("cartIcon",!1),r.resolve(e)}),r.promise},this.getListBySeller=function(){return e.get(ctx+"v3/cart/seller-list")},this.choose=function(t,o,n){return e.get(ctx+"v3/cart/choose/"+t,{params:{skuId:n,choose:o}})},this.getCart=function(e,t,o){var n;return e.forEach(function(e){e.sellerId==t&&e.skuId==o&&(n=e.goodNum)}),n}}]),services.service("orderService",["$http","$q",function(e,t){this.getOrder=function(t){return e.get(ctx+"v3/order/confirm/"+t)},this.confirm=function(o,n){var r=t.defer(),s=base64encode(utf16to8(angular.toJson(n)));return e.post(ctx+"v3/order/confirm/"+o,s).success(function(t){t.success?e.get(ctx+"pay/"+t.body,{params:{path:"v3"}}).success(function(e){r.resolve(e)}):r.resolve(t)}),r.promise},this.getChooseDate=function(t){return e.get(ctx+"v3/order/choosedate/"+t)}}]),services.factory("userService",["$http","$q",function(e,t){return{getAddressList:function(){return e.get(ctx+"v3/address/list")},address:function(t,o,n){return e.post(ctx+"v3/address/"+t+"/"+o,n)},gpsAddress:function(t,o,n){return e({method:"get",url:ctx+"v3/address/search",params:{kw:t,lat:o,lng:n}})},getDefAddress:function(){return e.get(ctx+"v3/address/default")},getcoupons:function(){return e.get(ctx+"v3/coupon/view")},getcollects:function(){return e.get(ctx+"v3/collects")},postcollect:function(t){return e.post(ctx+"v3/collects/"+t)},scanPay:function(t){return e.get(ctx+"v3/scan_pay/"+t)},scanGoPay:function(t,o,n,r,s,c){return e({method:"post",url:ctx+"v3/scan_go_pay/"+t,params:{payAmount:o,amount:n,actCardId:r,actUserId:s,isWxScan:c}})},scanPaySuccess:function(t){return e.get(ctx+"v3/scan_pay_success/"+t)},goPay:function(t){return e.get(ctx+"pay_req/"+t)}}}]),app.directive("addCart",["$rootScope","cartService",function(e,t){return{scope:{goods:"=",sellerId:"=",fun:"&"},link:function(o,n,r){n.on("click",function(n){t.add(o.sellerId,o.goods.skuId).success(function(t){t.success?(o.goods.goodNum=t.body.goodNum,e.$broadcast("cartIcon",!0),void 0!=o.fun&&o.fun(),r.pagename&&"detail"==r.pagename&&angular.element(document.getElementById("ng-view")).append('<div class="finishedwarn" id="finished">加入购物车成功</div>'),setTimeout(function(){angular.element(document.getElementById("finished")).remove()},1500)):alert(t.message)})})}}}]),app.directive("reduceCart",["$rootScope","cartService",function(e,t){return{scope:{goods:"=",sellerId:"=",fun:"&"},link:function(o,n,r){n.on("click",function(n){t.reduce(o.sellerId,o.goods.skuId).success(function(t){o.goods.goodNum=t.body.goodNum,e.$broadcast("cartIcon",!0),void 0!=o.fun&&o.fun()})})}}}]),app.directive("hlHeader",["$cookieStore","$routeParams","geoService","cartService","$location",function(e,t,o,n,r,s){return{restrict:"E",replace:!0,templateUrl:ctx+"html/v3/comm/header.tpl.html",scope:{seearound:"=",searchbox:"=",returnback:"=",middle:"=",type:"@",action:"&"},link:function(t,s,c){n.getList().then(function(e){e.body.length>0&&(t.cartIcon=!0)}),t.$on("cartIcon",function(e,o){t.cartIcon=o});var i=e.get("gps");"hidden"!=t.middle&&(void 0==i||void 0==i.address?(t.geo="定位中...",(new BMap.Geolocation).getCurrentPosition(function(n){if(this.getStatus()==BMAP_STATUS_SUCCESS){new BMap.Geocoder;o.getGeo(n.point.lng,n.point.lat).then(function(o){i=o,e.put("gps",i),t.geo=i.address,console.log(t.action()),t.action()})}else alert("failed"+this.getStatus())},{enableHighAccuracy:!0})):(t.geo=i.address,console.log(t.action()),t.action())),t.gotoSearch=function(){r.path("/goods/cat/"+i.sellerId+"/search")},t.closemess=function(){t.Error=!1}}}}]),app.directive("hlSwipe",[function(){var e=function(e,t,o){if(e.$last===!0){var n=t.parent().parent();angular.element(t);window.mySwipe=new Swipe(n[0],{auto:3e3,continuous:!0,callback:function(e,t){var o=angular.element(n.children()[1]),r=n.children()[0];o=o.children();var s=o.length;2==s&&e>s-1&&(r.children[e].innerHTML=r.children[e%s].innerHTML),o.removeClass("on"),angular.element(o[e%s]).addClass("on")}})}};return{link:e,priority:0}}]),app.directive("showmessage",["$timeout",function(e){return{restrict:"E",replace:!0,templateUrl:ctx+"html/v3/comm/showmessage.tpl.html",scope:{time:"@",text:"@"},link:function(t,o,n){if(angular.element(document.getElementsByTagName("body")).addClass("i-notscroll"),t.closemessageFn=function(){angular.element(document.getElementsByTagName("body")).removeClass("i-notscroll"),o.remove()},void 0!=t.time)var r=e(function(){t.closemessageFn(),e.cancel(r)},t.time)}}}]),app.directive("aggrement",["$http","$compile",function(e,t){return{scope:{},replace:!0,templateUrl:ctx+"html/v3/my/tpl/aggrement.tpl.html",link:function(t,o){t.addAggrement=function(){e.get(ctx+"v3/context/aggrement").success(function(e){angular.element(document.getElementById("aggrement")).html(e.body),t.show=!0})},t.close=function(){t.show=void 0}}}}]),app.directive("squarePicture",[function(){return{link:function(e,t,o){var n=angular.element(t)[0].width;angular.element(t)[0].height;angular.element(t)[0].height=n}}}]),app.directive("autoFocusWhen",["$log","$timeout",function(e,t){return{restrict:"A",scope:{autoFocusWhen:"="},link:function(e,o){e.$watch("autoFocusWhen",function(e){e&&t(function(){o[0].focus()})}),o.on("blur",function(){e.$apply(function(){e.autoFocusWhen=!1})})}}}]);var MOBILE_REGEX=/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/;app.directive("mobile",function(){return{require:"ngModel",restrict:"AE",link:function(e,t,o,n){n.$parsers.unshift(function(e){return MOBILE_REGEX.test(e)?(n.$setValidity("mobile",!0),e):void n.$setValidity("mobile",!1)})}}}).directive("collect",["$http","userService",function(e,t){return{replace:!0,templateUrl:ctx+"html/v3/seller/tpl/collect.tpl.html",scope:{sellerId:"=",show:"="},link:function(e,o,n){e.collects=function(){t.postcollect(e.sellerId).success(function(t){e.show=t.success&&t.body>0,void 0!=t.message&&(e.code=!0,e.message=t.message)})},e.close=function(){e.code=!1}}}}]);var util={getScrollTop:function(){var e=0,t=0,o=0;return document.body&&(t=document.body.scrollTop),document.documentElement&&(o=document.documentElement.scrollTop),e=t-o>0?t:o},getScrollHeight:function(){var e=0,t=0,o=0;return document.body&&(t=document.body.scrollHeight),document.documentElement&&(o=document.documentElement.scrollHeight),e=t-o>0?t:o},getWindowHeight:function(){var e=0;return e="CSS1Compat"==document.compatMode?document.documentElement.clientHeight:document.body.clientHeight}};app.directive("infiniteScroll",["$rootScope","$window","$timeout",function(e,t,o){return{link:function(n,r,s){var c,i,l,a;return t=angular.element(t),l=0,null!=s.infiniteScrollDistance&&n.$watch(s.infiniteScrollDistance,function(e){return l=parseInt(e,10)}),a=!0,c=!1,null!=s.infiniteScrollDisabled&&n.$watch(s.infiniteScrollDisabled,function(e){if(a=!e,a&&c)return c=!1,i()}),i=function(){var o,i,d,u;return u=util.getScrollTop()+util.getWindowHeight(),o=r[0].offsetTop+r[0].offsetHeight,i=o-u,d=i<=t[0].innerHeight*l,d&&a?e.$$phase?n.$eval(s.infiniteScroll):n.$apply(s.infiniteScroll):d?c=!0:void 0},t.on("scroll",i),n.$on("$destroy",function(){return t.off("scroll",i)}),o(function(){return s.infiniteScrollImmediateCheck?n.$eval(s.infiniteScrollImmediateCheck)?i():void 0:i()},0)}}}]),app.directive("showgoods",[function(){return{restrict:"AE",replace:!0,templateUrl:ctx+"html/v3/orders/tpl/goodslist.tpl.html",link:function(e,t,o){e.closePops=function(){t.remove()},e.totalNumber=0,e.orderGoods=e.order.orderGoods,e.orderGoods.forEach(function(t,o){e.totalNumber=e.totalNumber+t.goodsNumber})}}}]),app.directive("showtimes",["$timeout","$compile","orderService",function(e,t,o){return{restrict:"AE",replace:!0,templateUrl:ctx+"html/v3/orders/tpl/choosedate.tpl.html",link:function(e,n,r){e.closePops=function(){n.remove()},o.getChooseDate(e.order.sellerId).success(function(t){var o=t.body;e.orderTimes=o,e.list=o.today.list,e.choose=o.today.name}),e.chooseDay=function(t){e.list=t.list,e.choose=t.name},e.choosedate=function(t){e.showTime=t.day+" "+t.showTime,e.bestTime=t.bestTime},e.showMess=function(){void 0!=e.bestTime?(e.order.orderSendTime=e.showTime,e.order.bestTime=e.bestTime,n.remove()):n.append(t("<showmessage time=2000 text='请选择预约时间'></showmessage>")(e))}}}}]),app.directive("showcoupons",[function(){return{restrict:"AE",replace:!0,templateUrl:ctx+"html/v3/orders/tpl/choosecoupons.tpl.html",link:function(e,t,o){e.choose=function(t){e.red=t},e.confirm=function(o){void 0!=e.redFn&&e.redFn(e.red,!0),t.remove()},e.closePops=function(){t.remove()}}}}]),app.directive("addressSearch",["$cookieStore","userService",function(e,t){return{restrict:"AE",replace:!0,scope:{address:"="},templateUrl:ctx+"html/v3/address/address.search.tpl.html",link:function(o,n,r){o.search=function(){var n=e.get("gps");void 0==n&&(n={}),t.gpsAddress(o.key,n.lat,n.lng).success(function(e){o.addressList=e.body})},o.choosed=function(e){void 0==o.address&&(o.address={}),o.address.signBuilding=e.name,o.address.lat=e.lat,o.address.lng=e.lng,o.removedirective()},o.removedirective=function(){n.remove()},o.search(),o.showcities=!1,o.currentCity="杭州",e.put("currentCity","杭州"),o.citylist=[{city:"330100",name:"杭州"},{city:"500000",name:"重庆"}],o.showCitiesFn=function(){o.showcities=!0},o.changeCity=function(t){o.currentCity=t.name,e.put("currentCity",t.name),o.showcities=!1}}}}]),app.directive("showfeedpop",[function(){return{restrict:"AE",replace:!0,scope:{text:"=",nosubmit:"="},templateUrl:ctx+"html/v3/my/tpl/feedbackpop.tpl.html",link:function(e,t,o){e.submitok=function(){console.log("提交成功")},e.cancelsubmit=function(){t.remove()}}}}]),app.directive("packageGet",[function(){return{restrict:"AE",replace:!0,templateUrl:ctx+"html/v3/seller/tpl/package_get.tpl.html",link:function(e,t,o){e.remove=function(){t.remove()}}}}]),app.directive("packageBlank",["$http","$rootScope","$location",function(e,t,o){return{restrict:"AE",replace:!0,scope:{sellerId:"=",sellerName:"="},templateUrl:ctx+"html/v3/seller/tpl/package_blank.tpl.html",link:function(t,o,n){var r=ctx+"v3/homeRedPackage/"+t.sellerId;e.get(r).success(function(e){void 0!=e.body&&(t.show=!0,t.act=e.body)}),t.getpackage=function(){var o=new Array;t.act.forEach(function(e){o.push(e.id)}),e.post(r,o).success(function(e){e.success?(t.show=!1,t.hasAct=!0):alert(e.message)})},t.remove=function(){t.hasAct=!1},t.gotouseFn=function(e){e&&""!=e?window.location.href="#/goods/cat?sellerId="+t.sellerId+"&supplierId="+e:window.location.href="#/goods/cat?sellerId="+t.sellerId}}}}]),app.directive("getNumber",["$routeParams",function(e){return{link:function(e,t,o){t.on("touchstart",function(){e.amount+=t.children("span").html();var o=/^[^\.]*$/,n=e.amount.substring(0,1),r=e.amount.substring(1,2),s=e.amount.substring(2,3),c=e.amount.indexOf("."),i=e.amount.length,l=e.amount.substring(e.amount.indexOf("."),e.amount.length),a=e.amount.substring(0,e.amount.indexOf("."));
"0"===n&&"."!==r&&""!==r?e.amount=e.amount.substring(1,e.amount.length)+".00":"."===n&&"."!==r&&""!==r&&"."!==s&&""!==s?e.amount="0"+e.amount:"."===n&&"."===r?e.amount="0.00":o.test(l.substring(1,l.length))||"0.00"===e.amount||(l=l.substring(1,l.length).replace(".","0"),e.amount=a+"."+l),c!=-1&&i>3?e.amount=e.amount.substring(0,c+3):(e.amount=e.amount,a=e.amount),o.test(l.substring(1,l.length))||"0.00"===e.amount||(l=l.substring(1,l.length).replace(".","0"),e.amount=a+"."+l),parseInt(a)>=2e4&&(e.amount="20000"),angular.element(document.getElementById("amount")).val(e.amount),angular.element(document.getElementById("scanGoPay")).removeClass("gotoPay");var d=100*e.amount;if(e.payAmount=d,e.isLogin){var u=e.card;void 0!=u&&null!=u?0==u.isUse&&d>=u.sums&&(d-u.balance>0?e.payAmount=d-u.balance:e.payAmount=0):e.payAmount=d}angular.element(document.getElementById("payAmount")).html("￥"+(e.payAmount/100).toFixed(2))})}}}]),app.directive("deleteNumber",[function(){return{link:function(e,t,o){t.on("touchstart",function(){var t=e.amount.length;if(t>0){var o=e.amount.substring(0,t-1);e.amount=o;var n=100*e.amount;if(e.payAmount=n,e.isLogin){var r=e.card;void 0!=r&&null!=r?0==r.isUse&&n>=r.sums&&(n-r.balance>0?e.payAmount=n-r.balance:e.payAmount=0):e.payAmount=n}angular.element(document.getElementById("amount")).val(o),angular.element(document.getElementById("payAmount")).html("￥"+e.payAmount/100),angular.element(document.getElementById("scanGoPay")).removeClass("gotoPay")}else angular.element(document.getElementById("scanGoPay")).addClass("gotoPay")})}}}]);